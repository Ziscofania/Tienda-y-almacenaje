<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Formulaci√≥n de Proyectos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/Tienda down/src/styles/styles.css" />
</head>
<body>
  <div class="app-shell">
    <div class="card-shell">
      <header>
        <div>
          <h1>Formulaci√≥n de Proyectos</h1>
          <p>Versi√≥n web simplificada del Excel de formulaci√≥n: par√°metros, personal, producto, materia prima, activos, amortizaci√≥n, ventas y evaluaci√≥n.</p>
        </div>
        <div class="header-right">
          <div class="badge">
            <span class="dot"></span> Cliente: usuario ingresa datos ¬∑ C√°lculos en el navegador
          </div>
          <a class="btn-download" href="formulacion_taller.xlsx" download>
            üì• Descargar Excel original
          </a>
        </div>
      </header>

      <!-- Tabs -->
      <div class="tab-bar">
        <button class="tab-btn active" data-tab="1"><span class="num">1</span> Par√°metros</button>
        <button class="tab-btn" data-tab="2"><span class="num">2</span> Personal</button>
        <button class="tab-btn" data-tab="3"><span class="num">3</span> Producto y MP</button>
        <button class="tab-btn" data-tab="4"><span class="num">4</span> Activos</button>
        <button class="tab-btn" data-tab="5"><span class="num">5</span> Amortizaci√≥n</button>
        <button class="tab-btn" data-tab="6"><span class="num">6</span> Ventas</button>
        <button class="tab-btn" data-tab="7"><span class="num">7</span> Resultados</button>
      </div>

      <!-- Panel 1: Par√°metros -->
      <section class="panel active" id="panel-1">
        <h2>1. Par√°metros generales del proyecto</h2>
        <p class="help">
          Define el horizonte de evaluaci√≥n y los par√°metros macro. El <strong>capital de trabajo inicial</strong> se ingresa en pesos (ej. 140000000 = $140 millones).
        </p>

        <div class="grid-2">
          <div>
            <label for="p-anios">Horizonte del proyecto (a√±os)</label>
            <input type="number" id="p-anios" min="1" value="5">
          </div>
          <div>
            <label for="p-inflacion">% Inflaci√≥n anual esperada</label>
            <input type="number" id="p-inflacion" step="0.1" value="8">
          </div>
          <div>
            <label for="p-crec-ventas">% Crecimiento anual de ventas</label>
            <input type="number" id="p-crec-ventas" step="0.1" value="10">
          </div>
          <div>
            <label for="p-impuesto">% Impuesto a la utilidad</label>
            <input type="number" id="p-impuesto" step="0.1" value="35">
          </div>
          <div>
            <label for="p-van">% Tasa de descuento (VAN)</label>
            <input type="number" id="p-van" step="0.1" value="12">
          </div>
          <div>
            <label for="p-indir">% Costos indirectos sobre MP</label>
            <input type="number" id="p-indir" step="0.1" value="15">
          </div>
          <div>
            <label for="p-fijos">Otros costos fijos anuales (peso)</label>
            <input type="number" id="p-fijos" value="30000000" placeholder="30000000">
          </div>
          <div>
            <label for="p-ct">Capital de trabajo inicial (peso)</label>
            <input type="number" id="p-ct" value="140000000" placeholder="Ej: 140000000">
          </div>
        </div>

        <div class="btn-nav">
          <button class="btn secondary small" disabled>‚óÄ Anterior</button>
          <button class="btn small" data-next="2">Siguiente ‚ñ∂</button>
        </div>
      </section>

      <!-- Panel 2: Personal -->
      <section class="panel" id="panel-2">
        <h2>2. Personal</h2>
        <p class="help">
          Registra los cargos por √°rea. Puedes decidir si incluyes auxilio de transporte, prestaciones y seguridad social en el costo anual.
        </p>

        <div class="grid-2">
          <div>
            <label>√Årea</label>
            <select id="per-area">
              <option value="Administrativa">Administrativa</option>
              <option value="Ventas">√Årea de Ventas</option>
              <option value="Producci√≥n">√Årea de Producci√≥n</option>
              <option value="Otra">Otra</option>
            </select>
          </div>
          <div>
            <label>Cargo</label>
            <input type="text" id="per-cargo" placeholder="Ej: Gerente general">
          </div>
          <div>
            <label>Cantidad de personas</label>
            <input type="number" id="per-cant" min="1" value="1">
          </div>
          <div>
            <label>Sueldo mensual por persona (peso)</label>
            <input type="number" id="per-sueldo" value="2000000">
          </div>
        </div>

        <label class="mt-8">Componentes a incluir en el costo del personal</label>
        <div class="toggle-row">
          <label class="toggle-card active" id="toggle-aux">
            <input type="checkbox" id="chk-aux" checked>
            Auxilio de transporte (si aplica)
          </label>
          <label class="toggle-card active" id="toggle-prest">
            <input type="checkbox" id="chk-prest" checked>
            Prestaciones (primas, cesant√≠as, int. cesant√≠as, vacaciones)
          </label>
          <label class="toggle-card active" id="toggle-ss">
            <input type="checkbox" id="chk-ss" checked>
            Aportes seguridad social (empleador)
          </label>
        </div>

        <button class="btn small mt-8" id="btn-agregar-persona">‚ûï Agregar cargo</button>

        <div id="tabla-personal-wrapper"></div>

        <div class="btn-nav">
          <button class="btn secondary small" data-prev="1">‚óÄ Anterior</button>
          <button class="btn small" data-next="3">Siguiente ‚ñ∂</button>
        </div>
      </section>

      <!-- Panel 3: Producto y MP -->
      <section class="panel" id="panel-3">
        <h2>3. Producto y materia prima</h2>
        <p class="help">
          Este m√≥dulo asume <strong>un solo producto</strong> y varios ingredientes (materias primas) para su ‚Äúreceta‚Äù.
        </p>

        <h3>Producto</h3>
        <div class="grid-2">
          <div>
            <label>Nombre del producto</label>
            <input type="text" id="prod-nombre" placeholder="Ej: Pan artesanal">
          </div>
          <div>
            <label>Precio de venta unitario (peso)</label>
            <input type="number" id="prod-precio" value="3000">
          </div>
          <div>
            <label>Unidades a producir / vender A√±o 1</label>
            <input type="number" id="prod-unidades" value="100000">
          </div>
        </div>

        <h3 class="mt-12">Receta: ingredientes del producto</h3>
        <div class="grid-2">
          <div>
            <label>Ingrediente</label>
            <input type="text" id="mp-desc" placeholder="Ej: Harina de trigo">
          </div>
          <div>
            <label>Cantidad por unidad de producto</label>
            <input type="number" id="mp-cant-unit" step="0.0001" value="0.25">
          </div>
          <div>
            <label>Unidad</label>
            <select id="mp-unidad">
              <option value="kg">kg</option>
              <option value="lb">lb</option>
              <option value="g">g</option>
              <option value="unidad">unidad</option>
              <option value="litro">litro</option>
            </select>
          </div>
          <div>
            <label>Costo unitario del insumo (peso por unidad seleccionada)</label>
            <input type="number" id="mp-costo-unit" value="3500">
          </div>
        </div>
        <button class="btn small mt-8" id="btn-agregar-mp">‚ûï Agregar ingrediente</button>

        <div id="tabla-mp-wrapper"></div>

        <div class="btn-nav">
          <button class="btn secondary small" data-prev="2">‚óÄ Anterior</button>
          <button class="btn small" data-next="4">Siguiente ‚ñ∂</button>
        </div>
      </section>

      <!-- Panel 4: Activos -->
      <section class="panel" id="panel-4">
        <h2>4. Activos fijos</h2>
        <p class="help">Registra la inversi√≥n en activos, su vida √∫til y valor residual para la depreciaci√≥n anual.</p>

        <div class="grid-2">
          <div>
            <label>Descripci√≥n</label>
            <input type="text" id="act-desc" placeholder="Ej: Horno industrial">
          </div>
          <div>
            <label>Costo (peso)</label>
            <input type="number" id="act-costo" value="50000000">
          </div>
          <div>
            <label>Vida √∫til (a√±os)</label>
            <input type="number" id="act-vida" value="10">
          </div>
          <div>
            <label>Valor residual (peso)</label>
            <input type="number" id="act-residual" value="5000000">
          </div>
        </div>
        <button class="btn small mt-8" id="btn-agregar-activo">‚ûï Agregar activo</button>

        <div id="tabla-activos-wrapper"></div>

        <div class="btn-nav">
          <button class="btn secondary small" data-prev="3">‚óÄ Anterior</button>
          <button class="btn small" data-next="5">Siguiente ‚ñ∂</button>
        </div>
      </section>

      <!-- Panel 5: Amortizaci√≥n -->
      <section class="panel" id="panel-5">
        <h2>5. Amortizaci√≥n del cr√©dito</h2>
        <p class="help">
          Define el cr√©dito que financia parte de la inversi√≥n. Se calcula una tabla de amortizaci√≥n con cuota fija (sistema franc√©s).
        </p>

        <div class="grid-2">
          <div>
            <label>Monto del cr√©dito (peso)</label>
            <input type="number" id="am-monto" value="80000000">
          </div>
          <div>
            <label>Tasa efectiva anual (%)</label>
            <input type="number" id="am-tasa" value="16" step="0.1">
          </div>
          <div>
            <label>Plazo (a√±os)</label>
            <input type="number" id="am-anios" value="5">
          </div>
          <div>
            <label>Pagos por a√±o</label>
            <input type="number" id="am-pagos" value="1">
          </div>
        </div>

        <button class="btn small mt-8" id="btn-calcular-amort">üìë Calcular amortizaci√≥n</button>

        <div id="tabla-amort-wrapper"></div>

        <div class="btn-nav">
          <button class="btn secondary small" data-prev="4">‚óÄ Anterior</button>
          <button class="btn small" data-next="6">Siguiente ‚ñ∂</button>
        </div>
      </section>

      <!-- Panel 6: Ventas -->
      <section class="panel" id="panel-6">
        <h2>6. Ventas proyectadas</h2>
        <p class="help">
          Las ventas se calculan como <strong>precio √ó unidades</strong> del producto para el A√±o 1 y se aplican los par√°metros de crecimiento anual definidos en la pesta√±a 1.
        </p>

        <div id="tabla-ventas-wrapper"></div>

        <div class="btn-nav">
          <button class="btn secondary small" data-prev="5">‚óÄ Anterior</button>
          <button class="btn small" data-next="7">Siguiente ‚ñ∂</button>
        </div>
      </section>

      <!-- Panel 7: Resultados -->
      <section class="panel" id="panel-7">
        <div class="flex-between">
          <h2>7. Estado de resultados, flujo de caja y evaluaci√≥n</h2>
          <button class="btn small" id="btn-recalcular">Calcular todo ‚ñ∂</button>
        </div>

        <div class="kpi-row mt-8">
          <div class="kpi">
            <h4>VAN (Valor Actual Neto)</h4>
            <p id="kpi-van">$0</p>
          </div>
          <div class="kpi">
            <h4>TIR (Tasa Interna de Retorno estimada)</h4>
            <p id="kpi-tir">0%</p>
          </div>
          <div class="kpi muted small">
            <h4>Payback (a√±os)</h4>
            <p id="kpi-payback">-</p>
          </div>
        </div>

        <h3>Estado de resultados proyectado</h3>
        <div id="tabla-resultados-wrapper"></div>

        <h3 class="mt-12">Flujo de caja del proyecto</h3>
        <div id="tabla-flujos-wrapper"></div>

        <div class="btn-nav">
          <button class="btn secondary small" data-prev="6">‚óÄ Anterior</button>
          <button class="btn secondary small" disabled>Fin</button>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ===== Estado global =====
    let personalData = [];   // {area, cargo, cant, sueldo, aplicaAux, aplicaPrest, aplicaSS}
    let recetaMP = [];       // {desc, cantUnit, unidad, costoUnit}
    let activosData = [];    // {desc, costo, vida, residual}
    let amortizacionAnual = []; // {year, payment, interest, principal, balance}
    let ventasProy = [];     // {year, sales}

    const AUX_TRANSP_MES = 162000; // puedes cambiarlo si quieres

    // Par√°metros fijos de prestaciones (aprox Colombia)
    const P_PRIMA = 0.0833;
    const P_CES = 0.0833;
    const P_INT_CES = 0.01;
    const P_VAC = 0.0417;
    const P_PREST_TOTAL = P_PRIMA + P_CES + P_INT_CES + P_VAC; // ~0.2183
    const P_SEG_SOC = 0.30; // aporte empleador aprox (salud, pensi√≥n, riesgos)

    function getParams() {
      return {
        anios: Number(document.getElementById('p-anios').value) || 1,
        inflacion: Number(document.getElementById('p-inflacion').value) / 100,
        crecVentas: Number(document.getElementById('p-crec-ventas').value) / 100,
        impuesto: Number(document.getElementById('p-impuesto').value) / 100,
        tasaDesc: Number(document.getElementById('p-van').value) / 100,
        indirectosMP: Number(document.getElementById('p-indir').value) / 100,
        otrosFijos: Number(document.getElementById('p-fijos').value) || 0,
        capitalTrabajo: Number(document.getElementById('p-ct').value) || 0
      };
    }

    function getProducto() {
      return {
        nombre: document.getElementById('prod-nombre').value || 'Producto',
        precio: Number(document.getElementById('prod-precio').value) || 0,
        unidadesAno1: Number(document.getElementById('prod-unidades').value) || 0
      };
    }

    function fmtMoney(x) {
      if (isNaN(x)) return '$0';
      return '$' + x.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    function fmtPct(p) {
      if (isNaN(p)) return '0%';
      return (p * 100).toFixed(2) + '%';
    }

    // ===== Tabs =====
    const tabButtons = document.querySelectorAll('.tab-btn');
    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.dataset.tab;
        setActiveTab(id);
      });
    });

    function setActiveTab(id) {
      document.querySelectorAll('.panel').forEach(p => {
        p.classList.toggle('active', p.id === 'panel-' + id);
      });
      tabButtons.forEach(b => {
        b.classList.toggle('active', b.dataset.tab === id);
      });
    }

    document.querySelectorAll('[data-next]').forEach(btn => {
      btn.addEventListener('click', () => {
        setActiveTab(btn.dataset.next);
      });
    });

    document.querySelectorAll('[data-prev]').forEach(btn => {
      btn.addEventListener('click', () => {
        setActiveTab(btn.dataset.prev);
      });
    });

    // ===== Toggle cards (personal) =====
    function syncToggleCard(idCard, idChk) {
      const card = document.getElementById(idCard);
      const chk = document.getElementById(idChk);
      function refresh() {
        card.classList.toggle('active', chk.checked);
      }
      card.addEventListener('click', (e) => {
        if (e.target.tagName.toLowerCase() !== 'input') {
          chk.checked = !chk.checked;
        }
        refresh();
        renderPersonalTable();
        renderResultados();
      });
      chk.addEventListener('change', refresh);
      refresh();
    }
    syncToggleCard('toggle-aux', 'chk-aux');
    syncToggleCard('toggle-prest', 'chk-prest');
    syncToggleCard('toggle-ss', 'chk-ss');

    // ===== Personal =====
    document.getElementById('btn-agregar-persona').addEventListener('click', () => {
      const area = document.getElementById('per-area').value || 'Sin √°rea';
      const cargo = document.getElementById('per-cargo').value || 'Cargo';
      const cant = Number(document.getElementById('per-cant').value) || 1;
      const sueldo = Number(document.getElementById('per-sueldo').value) || 0;

      personalData.push({
        area, cargo, cant, sueldo,
        aplicaAux: document.getElementById('chk-aux').checked,
        aplicaPrest: document.getElementById('chk-prest').checked,
        aplicaSS: document.getElementById('chk-ss').checked
      });

      document.getElementById('per-cargo').value = '';
      renderPersonalTable();
      renderResultados();
    });

    function calcPersonalDetalle() {
      const totalesPorArea = {};
      let totalProyecto = 0;
      const filas = personalData.map((p, idx) => {
        const anualSalario = p.sueldo * 12;
        const anualAux = p.aplicaAux ? AUX_TRANSP_MES * 12 : 0;
        const anualPrest = p.aplicaPrest ? anualSalario * P_PREST_TOTAL : 0;
        const anualSS = p.aplicaSS ? anualSalario * P_SEG_SOC : 0;
        const costoPorPersona = anualSalario + anualAux + anualPrest + anualSS;
        const costoTotal = costoPorPersona * p.cant;

        if (!totalesPorArea[p.area]) totalesPorArea[p.area] = 0;
        totalesPorArea[p.area] += costoTotal;
        totalProyecto += costoTotal;

        return {
          idx,
          ...p,
          anualSalario,
          anualAux,
          anualPrest,
          anualSS,
          costoPorPersona,
          costoTotal
        };
      });
      return { filas, totalesPorArea, totalProyecto };
    }

    function renderPersonalTable() {
      const wrap = document.getElementById('tabla-personal-wrapper');
      if (!personalData.length) {
        wrap.innerHTML = '<p class="help">A√∫n no has registrado personal.</p>';
        return;
      }

      const { filas, totalesPorArea, totalProyecto } = calcPersonalDetalle();

      let html = '<table><thead><tr>' +
        '<th>√Årea</th><th>Cargo</th><th>Cant.</th>' +
        '<th>Salario anual</th><th>Auxilio anual</th><th>Prestaciones</th>' +
        '<th>Seg. social</th><th>Total/empleado</th><th>Total cargo</th><th></th></tr></thead><tbody>';

      filas.forEach(f => {
        html += `<tr>
          <td><span class="pill area">${f.area}</span></td>
          <td>${f.cargo}</td>
          <td>${f.cant}</td>
          <td>${fmtMoney(f.anualSalario)}</td>
          <td>${fmtMoney(f.anualAux)}</td>
          <td>${fmtMoney(f.anualPrest)}</td>
          <td>${fmtMoney(f.anualSS)}</td>
          <td>${fmtMoney(f.costoPorPersona)}</td>
          <td>${fmtMoney(f.costoTotal)}</td>
          <td><button class="btn small secondary" onclick="eliminarPersonal(${f.idx})">‚úï</button></td>
        </tr>`;
      });

      html += '</tbody><tfoot><tr><td colspan="8">Total proyecto</td>' +
        `<td>${fmtMoney(totalProyecto)}</td><td></td></tr></tfoot></table>`;

      // Subtotales por √°rea
      html += '<p class="help mt-8">Subtotales por √°rea:</p><ul style="font-size:12px; color:#e5e7eb; padding-left:18px;">';
      Object.entries(totalesPorArea).forEach(([area, val]) => {
        html += `<li><strong>${area}:</strong> ${fmtMoney(val)}</li>`;
      });
      html += '</ul>';

      wrap.innerHTML = html;
    }

    function eliminarPersonal(idx) {
      personalData.splice(idx, 1);
      renderPersonalTable();
      renderResultados();
    }
    window.eliminarPersonal = eliminarPersonal;

    function getTotalPersonalAnual() {
      const det = calcPersonalDetalle();
      return det.totalProyecto;
    }

    // ===== Materia prima (receta) =====
    document.getElementById('btn-agregar-mp').addEventListener('click', () => {
      const desc = document.getElementById('mp-desc').value || 'Ingrediente';
      const cantUnit = Number(document.getElementById('mp-cant-unit').value) || 0;
      const unidad = document.getElementById('mp-unidad').value;
      const costoUnit = Number(document.getElementById('mp-costo-unit').value) || 0;

      recetaMP.push({ desc, cantUnit, unidad, costoUnit });
      document.getElementById('mp-desc').value = '';
      document.getElementById('mp-cant-unit').value = '0';
      document.getElementById('mp-costo-unit').value = '0';
      renderMPTable();
      renderVentas();
      renderResultados();
    });

    function renderMPTable() {
      const wrap = document.getElementById('tabla-mp-wrapper');
      const prod = getProducto();
      if (!recetaMP.length) {
        wrap.innerHTML = '<p class="help">Registra al menos un ingrediente para calcular el costo de materia prima.</p>';
        return;
      }

      let costoUnitTotal = 0;
      recetaMP.forEach(r => {
        costoUnitTotal += r.cantUnit * r.costoUnit;
      });
      const costoMPAno1 = costoUnitTotal * prod.unidadesAno1;

      let html = '<table><thead><tr>' +
        '<th>Ingrediente</th><th>Cant. por unidad</th><th>Unidad</th>' +
        '<th>Costo unitario insumo</th><th>Costo MP / unidad prod.</th>' +
        '<th>Costo MP A√±o 1</th><th></th></tr></thead><tbody>';

      recetaMP.forEach((r, idx) => {
        const costoUnitProd = r.cantUnit * r.costoUnit;
        const costoAno1 = costoUnitProd * prod.unidadesAno1;
        html += `<tr>
          <td>${r.desc}</td>
          <td>${r.cantUnit}</td>
          <td>${r.unidad}</td>
          <td>${fmtMoney(r.costoUnit)}</td>
          <td>${fmtMoney(costoUnitProd)}</td>
          <td>${fmtMoney(costoAno1)}</td>
          <td><button class="btn small secondary" onclick="eliminarMP(${idx})">‚úï</button></td>
        </tr>`;
      });

      html += `<tfoot><tr><td colspan="5">Total materia prima A√±o 1</td><td>${fmtMoney(costoMPAno1)}</td><td></td></tr></tfoot>`;
      html += '</tbody></table>';

      wrap.innerHTML = html;
    }

    function eliminarMP(idx) {
      recetaMP.splice(idx, 1);
      renderMPTable();
      renderVentas();
      renderResultados();
    }
    window.eliminarMP = eliminarMP;

    function getCostoMPAno1() {
      const prod = getProducto();
      let costoUnitTotal = 0;
      recetaMP.forEach(r => {
        costoUnitTotal += r.cantUnit * r.costoUnit;
      });
      return costoUnitTotal * prod.unidadesAno1;
    }

    // ===== Activos =====
    document.getElementById('btn-agregar-activo').addEventListener('click', () => {
      const desc = document.getElementById('act-desc').value || 'Activo';
      const costo = Number(document.getElementById('act-costo').value) || 0;
      const vida = Number(document.getElementById('act-vida').value) || 1;
      const residual = Number(document.getElementById('act-residual').value) || 0;

      activosData.push({ desc, costo, vida, residual });
      document.getElementById('act-desc').value = '';
      renderActivosTable();
      renderResultados();
    });

    function renderActivosTable() {
      const wrap = document.getElementById('tabla-activos-wrapper');
      if (!activosData.length) {
        wrap.innerHTML = '<p class="help">A√∫n no has registrado activos fijos.</p>';
        return;
      }

      let totalInversion = 0;
      let totalDep = 0;
      let html = '<table><thead><tr>' +
        '<th>Activo</th><th>Costo</th><th>Vida √∫til</th>' +
        '<th>Valor residual</th><th>Depreciaci√≥n anual</th><th></th></tr></thead><tbody>';

      activosData.forEach((a, idx) => {
        const dep = (a.costo - a.residual) / a.vida;
        totalInversion += a.costo;
        totalDep += dep;
        html += `<tr>
          <td>${a.desc}</td>
          <td>${fmtMoney(a.costo)}</td>
          <td>${a.vida}</td>
          <td>${fmtMoney(a.residual)}</td>
          <td>${fmtMoney(dep)}</td>
          <td><button class="btn small secondary" onclick="eliminarActivo(${idx})">‚úï</button></td>
        </tr>`;
      });

      html += `<tfoot><tr><td colspan="4">Total inversi√≥n inicial en activos</td><td>${fmtMoney(totalDep)}</td><td></td></tr>`;
      html += `<tr><td colspan="4">Inversi√≥n en activos (costo)</td><td>${fmtMoney(totalInversion)}</td><td></td></tr></tfoot>`;
      html += '</tbody></table>';

      wrap.innerHTML = html;
    }

    function eliminarActivo(idx) {
      activosData.splice(idx, 1);
      renderActivosTable();
      renderResultados();
    }
    window.eliminarActivo = eliminarActivo;

    function getTotalDepreciacionAnual() {
      return activosData.reduce((sum, a) => sum + ((a.costo - a.residual) / a.vida), 0);
    }

    function getTotalInversionActivos() {
      return activosData.reduce((sum, a) => sum + a.costo, 0);
    }

    // ===== Amortizaci√≥n =====
    document.getElementById('btn-calcular-amort').addEventListener('click', () => {
      calcularAmortizacion();
      renderAmortTable();
      renderResultados();
    });

    function calcularAmortizacion() {
      amortizacionAnual = [];
      const monto = Number(document.getElementById('am-monto').value) || 0;
      const tasaEA = Number(document.getElementById('am-tasa').value) / 100 || 0;
      const anios = Number(document.getElementById('am-anios').value) || 1;
      const pagosAnio = Number(document.getElementById('am-pagos').value) || 1;

      if (monto <= 0 || tasaEA <= 0) return;

      const periodo = tasaEA / pagosAnio;
      const n = anios * pagosAnio;
      const pago = monto * (periodo * Math.pow(1 + periodo, n)) / (Math.pow(1 + periodo, n) - 1);

      let saldo = monto;

      for (let year = 1; year <= anios; year++) {
        let intYear = 0;
        let capYear = 0;
        for (let p = 1; p <= pagosAnio; p++) {
          const interes = saldo * periodo;
          const capital = pago - interes;
          saldo -= capital;
          intYear += interes;
          capYear += capital;
        }
        amortizacionAnual.push({
          year,
          payment: pago * pagosAnio,
          interest: intYear,
          principal: capYear,
          balance: Math.max(0, saldo)
        });
      }
    }

    function renderAmortTable() {
      const wrap = document.getElementById('tabla-amort-wrapper');
      if (!amortizacionAnual.length) {
        wrap.innerHTML = '<p class="help">Ingresa los par√°metros y pulsa "Calcular amortizaci√≥n".</p>';
        return;
      }
      let html = '<table><thead><tr>' +
        '<th>A√±o</th><th>Pago total</th><th>Intereses</th><th>Abono a capital</th><th>Saldo</th></tr></thead><tbody>';
      amortizacionAnual.forEach(r => {
        html += `<tr>
          <td>A√±o ${r.year}</td>
          <td>${fmtMoney(r.payment)}</td>
          <td>${fmtMoney(r.interest)}</td>
          <td>${fmtMoney(r.principal)}</td>
          <td>${fmtMoney(r.balance)}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      wrap.innerHTML = html;
    }

    // ===== Ventas =====
    function calcVentas() {
      const params = getParams();
      const prod = getProducto();
      ventasProy = [];
      let ventasAno1 = prod.precio * prod.unidadesAno1;
      for (let year = 1; year <= params.anios; year++) {
        const factor = Math.pow(1 + params.crecVentas, year - 1);
        const ventas = ventasAno1 * factor;
        ventasProy.push({ year, sales: ventas });
      }
    }

    function renderVentas() {
      calcVentas();
      const wrap = document.getElementById('tabla-ventas-wrapper');
      if (!ventasProy.length) {
        wrap.innerHTML = '<p class="help">Completa la informaci√≥n del producto y la receta para ver las ventas.</p>';
        return;
      }
      let html = '<table><thead><tr><th>A√±o</th><th>Ventas proyectadas</th></tr></thead><tbody>';
      ventasProy.forEach(v => {
        html += `<tr><td>A√±o ${v.year}</td><td>${fmtMoney(v.sales)}</td></tr>`;
      });
      html += '</tbody></table>';
      wrap.innerHTML = html;
    }

    // ===== Resultados y flujos =====
    document.getElementById('btn-recalcular').addEventListener('click', () => {
      renderResultados();
      alert('C√°lculos actualizados.');
    });

    function renderResultados() {
      const params = getParams();
      calcVentas();

      const anios = params.anios;
      const inflacion = params.inflacion;
      const tasaImp = params.impuesto;
      const indirectosMP = params.indirectosMP;
      const otrosFijos = params.otrosFijos;
      const capitalTrabajo = params.capitalTrabajo;

      const costoMPAno1 = getCostoMPAno1();
      const costoPersonalBase = getTotalPersonalAnual();
      const depAnual = getTotalDepreciacionAnual();

      // Estado de resultados
      let htmlRes = '<table><thead><tr>' +
        '<th>A√±o</th><th>Ventas</th><th>Costo MP + indir.</th><th>Costo personal</th>' +
        '<th>Otros fijos</th><th>Depreciaci√≥n</th><th>Intereses</th>' +
        '<th>Impuesto</th><th>Utilidad neta</th></tr></thead><tbody>';

      const resultados = [];
      for (let year = 1; year <= anios; year++) {
        const ventas = ventasProy[year - 1]?.sales || 0;
        const factorInfl = Math.pow(1 + inflacion, year - 1);
        const costoMP = costoMPAno1 * factorInfl;
        const costoIndir = costoMP * indirectosMP;
        const costoPersonal = costoPersonalBase * factorInfl;
        const intereses = amortizacionAnual[year - 1]?.interest || 0;
        const pagoCapital = amortizacionAnual[year - 1]?.principal || 0;

        const ebit = ventas - costoMP - costoIndir - costoPersonal - otrosFijos - depAnual;
        const ebt = ebit - intereses;
        const imp = ebt > 0 ? ebt * tasaImp : 0;
        const utilNeta = ebt - imp;
        const flujoOper = utilNeta + depAnual;
        resultados.push({
          year, ventas, costoMP: costoMP + costoIndir,
          costoPersonal, otrosFijos, dep: depAnual,
          intereses, imp, utilNeta, flujoOper, pagoCapital
        });

        htmlRes += `<tr>
          <td>A√±o ${year}</td>
          <td>${fmtMoney(ventas)}</td>
          <td>${fmtMoney(costoMP + costoIndir)}</td>
          <td>${fmtMoney(costoPersonal)}</td>
          <td>${fmtMoney(otrosFijos)}</td>
          <td>${fmtMoney(depAnual)}</td>
          <td>${fmtMoney(intereses)}</td>
          <td>${fmtMoney(imp)}</td>
          <td>${fmtMoney(utilNeta)}</td>
        </tr>`;
      }
      htmlRes += '</tbody></table>';
      document.getElementById('tabla-resultados-wrapper').innerHTML = htmlRes;

      // Flujos de caja
      const inversionActivos = getTotalInversionActivos();
      const montoCredito = Number(document.getElementById('am-monto').value) || 0;
      const inversionInicialNeta = inversionActivos + capitalTrabajo - montoCredito;

      let htmlFlu = '<table><thead><tr>' +
        '<th>A√±o</th><th>Flujo operativo</th><th>Abono a capital</th>' +
        '<th>Inversi√≥n inicial / CT</th><th>Flujo neto</th>' +
        '<th>Flujo acumulado</th></tr></thead><tbody>';

      const flujos = [];
      let acum = -inversionInicialNeta;
      flujos.push({ year: 0, cf: -inversionInicialNeta });

      htmlFlu += `<tr><td>A√±o 0</td><td>-</td><td>-</td><td>${fmtMoney(-inversionInicialNeta)}</td><td>${fmtMoney(-inversionInicialNeta)}</td><td>${fmtMoney(acum)}</td></tr>`;

      for (let r of resultados) {
        const invCT = 0;
        const cf = r.flujoOper - r.pagoCapital + invCT;
        acum += cf;
        flujos.push({ year: r.year, cf });
        htmlFlu += `<tr>
          <td>A√±o ${r.year}</td>
          <td>${fmtMoney(r.flujoOper)}</td>
          <td>${fmtMoney(r.pagoCapital)}</td>
          <td>${invCT === 0 ? '-' : fmtMoney(invCT)}</td>
          <td>${fmtMoney(cf)}</td>
          <td>${fmtMoney(acum)}</td>
        </tr>`;
      }
      htmlFlu += '</tbody></table>';
      document.getElementById('tabla-flujos-wrapper').innerHTML = htmlFlu;

      // VAN y TIR
      const tasaDesc = params.tasaDesc;
      let van = 0;
      flujos.forEach(f => {
        van += f.cf / Math.pow(1 + tasaDesc, f.year);
      });
      document.getElementById('kpi-van').textContent = fmtMoney(van);

      let tir = calcularTIR(flujos.map(f => f.cf));
      document.getElementById('kpi-tir').textContent = isFinite(tir) ? (tir*100).toFixed(2) + '%' : 'N/A';

      // Payback
      let acum2 = 0;
      let payback = null;
      const flujosSin0 = flujos.slice(1);
      for (let f of flujosSin0) {
        acum2 += f.cf;
        if (acum2 + flujos[0].cf >= 0) {
          payback = f.year;
          break;
        }
      }
      const payEl = document.getElementById('kpi-payback');
      if (payback === null) {
        payEl.textContent = 'No se recupera';
        payEl.className = 'badge-payback-bad';
      } else {
        payEl.textContent = payback + ' a√±o(s)';
        payEl.className = 'badge-payback-good';
      }
    }

    function calcularTIR(flujos) {
      // b√∫squeda simple entre -0.9 y 1.0
      let low = -0.9, high = 1.0, mid;
      const npv = (rate) => flujos.reduce((acc, cf, i) => acc + cf / Math.pow(1+rate, i), 0);
      let npvLow = npv(low), npvHigh = npv(high);
      if (npvLow * npvHigh > 0) return NaN;
      for (let i = 0; i < 60; i++) {
        mid = (low + high) / 2;
        let v = npv(mid);
        if (Math.abs(v) < 1e-4) break;
        if (npvLow * v < 0) {
          high = mid; npvHigh = v;
        } else {
          low = mid; npvLow = v;
        }
      }
      return mid;
    }

    // Render inicial
    renderPersonalTable();
    renderMPTable();
    renderActivosTable();
    calcularAmortizacion();
    renderAmortTable();
    renderVentas();
    renderResultados();
  </script>
</body>
</html>